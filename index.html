<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Live Weather, Time & Wind Chill</title>
<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#1e3c72;
  color:white;
  text-align:center;
}
.box{
  margin-top:100px;
  background:rgba(0,0,0,0.5);
  padding:25px;
  border-radius:15px;
  display:inline-block;
}
input,button{
  padding:10px;
  font-size:16px;
  border-radius:8px;
  border:none;
}
#out{margin-top:20px;font-size:18px;}
</style>
</head>

<body>
<h1>üå¶Ô∏è Live Weather, Wind Chill & Time</h1>

<div class="box">
  <input id="city" placeholder="Enter City">
  <button onclick="startLive()">Start Live</button>
  <div id="out"></div>
</div>

<script>
let intervalId;

function calculateWindChill(tempC, windKmh){
  if(tempC > 10 || windKmh < 4.8) return tempC.toFixed(1);
  const v = windKmh, t = tempC;
  return (13.12 + 0.6215*t - 11.37*Math.pow(v,0.16) + 0.3965*t*Math.pow(v,0.16)).toFixed(1);
}

async function updateWeather(lat, lon, timezone, name){
  try{
    const weatherRes = await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`
    );
    const w = await weatherRes.json();
    const temp = w.current_weather.temperature;
    const wind = w.current_weather.windspeed;
    const chill = calculateWindChill(temp, wind);
    const now = new Date().toLocaleString("en-AU",{timeZone: timezone,hour12:true,hour:"2-digit",minute:"2-digit",second:"2-digit"});
    document.getElementById("out").innerHTML =
      `<b>${name}</b><br>`+
      `Temp: ${temp} ¬∞C<br>`+
      `Wind: ${wind} km/h<br>`+
      `Wind Chill: ${chill} ¬∞C<br>`+
      `Local Time: ${now}`;
  }catch{
    document.getElementById("out").textContent="Error fetching data";
  }
}

async function startLive(){
  const cityInput = document.getElementById("city").value.trim();
  if(intervalId) clearInterval(intervalId);

  // Try geolocation first
  if(navigator.geolocation && !cityInput){
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      const tzRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m`);
      const tzData = await tzRes.json();
      const timezone = tzData.timezone || "Australia/Melbourne";
      updateWeather(lat, lon, timezone, "Your Location");
      intervalId = setInterval(()=>updateWeather(lat, lon, timezone, "Your Location"),1000);
    }, ()=>{
      document.getElementById("out").textContent="Permission denied. Enter city below.";
    });
  }else if(cityInput){
    // Use city name if typed
    try{
      const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(cityInput)}&count=1`);
      const geo = await geoRes.json();
      if(!geo.results){document.getElementById("out").textContent="City not found"; return;}
      const {latitude, longitude, name, timezone} = geo.results[0];
      updateWeather(latitude, longitude, timezone, name);
      intervalId = setInterval(()=>updateWeather(latitude, longitude, timezone, name),1000);
    }catch{
      document.getElementById("out").textContent="Error fetching city";
    }
  }else{
    document.getElementById("out").textContent="Enter city or allow location";
  }
}
</script>

</body>
</html>
